<!DOCTYPE html>
<html lang="en">

<head>
    <title>Low Poly Islands</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <style>
        body {
            font-family: Monospace;
            background-color: #000;
            color: #fff;
            margin: 0 0 0 0;
            padding: 0 0 0 0;
            border: none;
            cursor: default;
        }

        #info {
            color: #fff;
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            z-index: 100;
            display: block;
        }

        #info a {
            color: #f00;
            font-weight: bold;
            text-decoration: underline;
            cursor: pointer
        }

        #glFullscreen {
            width: 80%;
            height: 80%;
            min-width: 640px;
            min-height: 360px;
            position: relative;
            overflow: hidden;
            z-index: 0;
        }

        #example {
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background-color: #000000;
        }

        #feedback {
            color: darkorange;
        }

        #dat {
            user-select: none;
            position: absolute;
            left: 0;
            top: 0;
            z-Index: 200;
        }

        #blocker {

            position: absolute;

            width: 100%;
            height: 100%;

            background-color: rgba(0, 0, 0, 0.5);

        }

        #instructions {

            width: 100%;
            height: 100%;

            display: -webkit-box;
            display: -moz-box;
            display: box;

            -webkit-box-orient: horizontal;
            -moz-box-orient: horizontal;
            box-orient: horizontal;

            -webkit-box-pack: center;
            -moz-box-pack: center;
            box-pack: center;

            -webkit-box-align: center;
            -moz-box-align: center;
            box-align: center;

            color: #ffffff;
            text-align: center;

            cursor: pointer;

        }

        #video {
            position: fixed;
            width: 0%;
            height: 0%;
            left: 0;
            bottom: 0;
        }
    </style>
</head>

<body>
    <embed src="music/bgm2.mp3" hidden="true" autostart="true" loop="true"> 
    <!-- <div id="glFullscreen">
    <canvas id="example"></canvas>
</div>
<div id="dat">

</div> -->

    <script src="src/three.js"></script>
    <script src="src/PointerLockControls.js"></script>
    <script src="src/Detector.js"></script>
    <script src="src/TrackballControls.js"></script>
    <script src="src/MTLLoader.js"></script>
    <script src="src/OBJLoader.js"></script>
    <script src="src/dat.gui.min.js"></script>
    <script src="src/LoaderSupport.js"></script>
    <script src="src/OBJLoader2.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.0.2/TweenMax.min.js"></script>
    <script src="js/myAABB.js"></script>
    <script src="js/Forest.js"></script>
    <script src="js/Decoration.js"></script>
    <script src="js/Cows.js"></script>
    <script src="js/Rabbits.js"></script>
    <script src="js/Wolfs.js"></script>
    <script src="js/Hedgehogs.js"></script>
    <script src="js/Water.js"></script>
    <script src="js/Sky.js"></script>
    <script src="js/Lensflare.js"></script>
    <script src="js/House.js"></script>
    <!-- <script src="js/dat.gui.min.js"></script> -->
    <video id="video" autoplay vcontrol>
        <source src="video.mp4" type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'>
    </video>
    <!--
<script src="js/Sky.js"></script>
-->
    <div id="blocker">

        <div id="instructions">
            <span style="font-size:40px">Click to play</span>
            <br />
            (W, A, S, D = Move, SPACE = Jump, MOUSE = Look around)
        </div>

    </div>

    <script>

        'use strict';

        var vcontrol;

        var moveForward = false;

        var moveBackward = false;

        var moveLeft = false;

        var moveRight = false;

        var canJump = false;

        var running = false;

        var velocity = new THREE.Vector3();

        var Outer = (function () {

            var Validator = THREE.LoaderSupport.Validator;

            var viewPara = [4, 4, 4];

            //function Outer( elementToBindTo ) {
            function Outer() {
                this.renderer = null;
                // this.canvas = elementToBindTo;
                this.aspectRatio = 1;
                // this.recalcAspectRatio();

                this.scene = null;

                this.viewcamera = null;

                // Flags
                this.loading = true;

                // Those Assets
                this.objectSet = new THREE.Group();
                // House
                this.house = null;
                // Animals
                this.forest = null;
                this.cows = null;
                this.rabbits = null;
                this.wolfs = null;
                this.hedgehogs = null;
                this.barn = null;
                // Others
                this.ballon = null;
                this.airship = null;
                this.lake = null;
                this.timeDay = 0;

                // raycaster
                this.raycaster = null;

                // more
                this.prevTime = performance.now();

                this.direction = new THREE.Vector3();
                this.vertex = new THREE.Vector3();

                this.viewAABB = null;
                this.barnAABB = null;
            }

            Outer.prototype.initGL = function () {
           
                this.raycaster = new THREE.Raycaster(new THREE.Vector3(), new THREE.Vector3(0, - 1, 0), 0, 10);

                this.renderer = new THREE.WebGLRenderer({
                    // canvas: this.canvas,
                    antialias: true,
                    autoClear: true,
                    alpha: true
                });
                this.renderer.setClearColor(0x050505);


                this.scene = new THREE.Scene();

                // Modify here
                // this.scene.fog = new THREE.Fog( 0xffffff, 0, 750 );

                // this.scene.background = new THREE.Color( 0xffffff );

                var light = new THREE.HemisphereLight(0xeeeeff, 0x777788, 0.75);
                light.position.set(0.5, 1, 0.75);
                this.scene.add(light);

                this.viewcamera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.05, 1000);
                vcontrol = new THREE.PointerLockControls(this.viewcamera);

                var blocker = document.getElementById('blocker');
                var instructions = document.getElementById('instructions');

                instructions.addEventListener('click', function () {

                    vcontrol.lock();
                    // console.log("What's wrong here");

                }, false);

                vcontrol.addEventListener('lock', function () {

                    instructions.style.display = 'none';
                    blocker.style.display = 'none';

                });

                vcontrol.addEventListener('unlock', function () {

                    blocker.style.display = 'block';
                    instructions.style.display = '';

                });

                vcontrol.getObject().position.x = 130;
                //vcontrol.getObject().position.y = 0;
                vcontrol.getObject().position.z = 240;
                
                this.viewAABB = new myAABB(
                                    calculateMyAABB( 
                                        [vcontrol.getObject().rotation.x, vcontrol.getObject().rotation.y, vcontrol.getObject().rotation.z], 
                                        [vcontrol.getObject().position.x, vcontrol.getObject().position.y, vcontrol.getObject().position.z], 
                                        viewPara[0]*vcontrol.getObject().scale.x, 
                                        viewPara[1]*vcontrol.getObject().scale.y, 
                                        viewPara[2]*vcontrol.getObject().scale.z
                                    )
                                );
                
                this.scene.add(vcontrol.getObject());

                // handle !

                this.resetCamera();
                // keyboard
                document.addEventListener('keydown', this.onKeyDown, false);
                document.addEventListener('keyup', this.onKeyUp, false);

                //var ambientLight = new THREE.AmbientLight( 0x404040, 0.0 );
                var sunLight = new THREE.PointLight(0x010101, 0.01, 700, 2);
                sunLight.position.set(500, 500, 200);
                var directionalLight1 = new THREE.DirectionalLight(0x808080);
                var directionalLight2 = new THREE.DirectionalLight(0x808080);
                // 0xC0C090
                directionalLight1.position.set(-100, -50, 100);
                directionalLight2.position.set(100, 50, -100);

                this.scene.add(directionalLight1);
                this.scene.add(directionalLight2);

                this.sunZoom();

            };

            // Some misc
            Outer.prototype.ballonUp = function () {
                //function ballonUp() {
                var _this = this;
                TweenMax.to(this.ballon.position, 6, { y: 200, ease: Power1.easeInOut, onComplete: function () { _this.ballonDown() } });
            }

            Outer.prototype.ballonDown = function () {
                //function ballonDown() {
                var _this = this;
                TweenMax.to(this.ballon.position, 6, { y: 0, ease: Power1.easeInOut, onComplete: function () { _this.ballonUp() } });
            }

            Outer.prototype.sunZoom = function () {
                var dirLight = new THREE.DirectionalLight(0xffffff, 0.05);
                dirLight.position.set(5000, 1000, -1000).normalize();
                dirLight.color.setHSL(0.1, 0.7, 0.5);
                var _ss = this.scene;
                _ss.add(dirLight);
                // lensflares
                var textureLoader = new THREE.TextureLoader();
                var textureFlare0 = textureLoader.load('assets/lensflare/lensflare0.png');
                var textureFlare3 = textureLoader.load('assets/lensflare/lensflare3.png');
                addLight(0.55, 0.9, 0.5, -5000, 1000, -1000);
                addLight(0.08, 0.8, 0.5, -5000, 1000, -1000);
                addLight(0.995, 0.5, 0.9, -5000, 1000, -1000);
                function addLight(h, s, l, x, y, z) {
                    var light = new THREE.PointLight(0xffffff, 1.5, 2000);
                    light.color.setHSL(h, s, l);
                    light.position.set(x, y, z);
                    _ss.add(light);
                    var lensflare = new THREE.Lensflare();
                    lensflare.addElement(new THREE.LensflareElement(textureFlare0, 700, 0, light.color));
                    lensflare.addElement(new THREE.LensflareElement(textureFlare3, 60, 0.6));
                    lensflare.addElement(new THREE.LensflareElement(textureFlare3, 70, 0.7));
                    lensflare.addElement(new THREE.LensflareElement(textureFlare3, 120, 0.9));
                    lensflare.addElement(new THREE.LensflareElement(textureFlare3, 70, 1));
                    light.add(lensflare);
                }
            }

            Outer.prototype.initContent = function () {
                var modelName = 'low-poly world';

                var scope = this;
                var objLoader2 = new THREE.OBJLoader2();

                var onLoadMtl = function (materials, materialCreator) {
                    var objLoader = new THREE.OBJLoader();
                    objLoader.setMaterials(materialCreator);
                    objLoader.load('./models/low-poly-islands.obj', function (object) {
                        // Here append anythins

                        // The house
                        scope.house = new House();
                        scope.house._mesh.position.set(130, 99, 200);
                        scope.house._mesh.scale.set(0.2, 0.2, 0.2);
                        // scope.house._mesh.rotation.y = -Math.PI/180*20;
                        object.add(scope.house._mesh);

                        // The Trees
                        scope.forest = new Forest();
                        object.add(scope.forest.mesh);

                        // The cows
                        scope.cows = new Cows();
                        object.add(scope.cows.mesh);

                        // The rabbits
                        scope.rabbits = new Rabbits();
                        object.add(scope.rabbits.mesh);

                        // The wolfs
                        scope.wolfs = new Wolfs();
                        object.add(scope.wolfs.mesh);

                        // The hedgehogs
                        scope.hedgehogs = new Hedgehogs();
                        object.add(scope.hedgehogs.mesh);

                        // The ballon
                        scope.ballon = object.children[4];

                        // The airship
                        scope.airship = object.children[7];

                        // The barn
                        scope.barn = object.children[11];
                        scope.barnAABB = new myAABB(
                                                calculateMyAABB( 
                                                    [0, 0, 0], 
                                                    [196, 103, 148], 
                                                    15,20,22
                                                    )
                                                );

                        console.log(scope.barnAABB);

                        scope.lake = new Lake();
                        object.add(scope.lake.mesh);

                        scope.objectSet.add(object);

                        scope.loading = false;

                        scope.rabbits.rabbits[0].trigger("nod", null);

                        scope.wolfs.wolfs[0].trigger("nod", null);

                        scope.hedgehogs.hedgehogs[0].nod();
                        
                        for (var i = 0; i < scope.cows.cows.length; i++) {
                            scope.cows.cows[i].trigger("nod", null);
                        }

                        scope.ballonUp();
                    });
                };
                objLoader2.loadMtl('./models/low-poly-islands.mtl', null, onLoadMtl);

                this.scene.add(this.objectSet);
                this.loadSkyBox();
            };

            Outer.prototype.resizeDisplayGL = function () {

                this.viewcamera.aspect = window.innerWidth / window.innerHeight;
                this.viewcamera.updateProjectionMatrix();
                
                this.renderer.setSize(window.innerWidth, window.innerHeight, false);
                this.updateCamera();
            };

            Outer.prototype.recalcAspectRatio = function () {
                this.aspectRatio = (this.canvas.offsetHeight === 0) ? 1 : this.canvas.offsetWidth / this.canvas.offsetHeight;
            };

            Outer.prototype.resetCamera = function () {
                this.updateCamera();
            };

            Outer.prototype.updateCamera = function () {
                if (vcontrol.isLocked === true) {
                    this.raycaster.ray.origin.copy(vcontrol.getObject().position);
                    this.raycaster.ray.origin.y += 3;
                    var intersections = this.raycaster.intersectObjects(this.scene.children, true);
                    var onObject = intersections.length > 0;
                    // console.log("The intersections:" + intersections.length)
                    var time = performance.now();
                    var delta = (time - this.prevTime) / 1000;

                    velocity.x -= velocity.x * 10.0 * delta;
                    velocity.z -= velocity.z * 10.0 * delta;
                    velocity.y -= 9.8 * 10.0 * delta;
                    this.direction.z = Number(moveForward) - Number(moveBackward);
                    this.direction.x = Number(moveLeft) - Number(moveRight);
                    this.direction.normalize(); // this ensures consistent movements in all directions

                    var speed = (running) ? 200:100;

                    if (moveForward || moveBackward) velocity.z -= this.direction.z * speed * delta;
                    if (moveLeft || moveRight) velocity.x -= this.direction.x * speed * delta;
 
                    if (onObject == true) {
                            velocity.y = Math.max(0, velocity.y);
                            canJump = true;
                    }

                    vcontrol.getObject().translateX(velocity.x * delta);
                    vcontrol.getObject().translateY(velocity.y * delta);
                    vcontrol.getObject().translateZ(velocity.z * delta);


                    this.viewAABB.update(
                                calculateMyAABB( 
                                    [vcontrol.getObject().rotation.x, vcontrol.getObject().rotation.y, vcontrol.getObject().rotation.z], 
                                    [vcontrol.getObject().position.x, vcontrol.getObject().position.y, vcontrol.getObject().position.z], 
                                    viewPara[0]*vcontrol.getObject().scale.x, 
                                    viewPara[1]*vcontrol.getObject().scale.y, 
                                    viewPara[2]*vcontrol.getObject().scale.z
                                    )
                                );

                    this.collideDetect();
                    var ifCollide = this.viewAABB.iscollision;
                    if (ifCollide) {
                        vcontrol.getObject().translateX(-velocity.x * delta);
                        vcontrol.getObject().translateY(-velocity.y * delta);
                        vcontrol.getObject().translateZ(-velocity.z * delta);
                        this.viewAABB.collisionOver();
                        if (moveForward || moveBackward) velocity.z += this.direction.z * speed * delta;
                        if (moveLeft || moveRight) velocity.x += this.direction.x * speed * delta;
                    }

                    if (vcontrol.getObject().position.y < 60) {
                            velocity.y = 0;
                            vcontrol.getObject().position.y = 150;
                            canJump = true;

                    }
                    this.prevTime = time;
                }
                
            };

            Outer.prototype.render = function () {
                if (!this.renderer.autoClear) this.renderer.clear();
                this.renderer.render(this.scene, this.viewcamera);
                this.updateCamera();
            };

            Outer.prototype.loadSkyBox = function () {
                var aCubeMap = THREE.ImageUtils.loadTextureCube([
                    'assets/img/px.jpg',
                    'assets/img/nx.jpg',
                    'assets/img/py.jpg',
                    'assets/img/ny.jpg',
                    'assets/img/pz.jpg',
                    'assets/img/nz.jpg'
                ]);
                aCubeMap.format = THREE.RGBFormat;

                var aShader = THREE.ShaderLib['cube'];
                aShader.uniforms['tCube'].value = aCubeMap;

                var aSkyBoxMaterial = new THREE.ShaderMaterial({
                    fragmentShader: aShader.fragmentShader,
                    vertexShader: aShader.vertexShader,
                    uniforms: aShader.uniforms,
                    depthWrite: false,
                    side: THREE.BackSide
                });

                var aSkybox = new THREE.Mesh(
                    new THREE.BoxGeometry(100000000, 100000000, 100000000),
                    aSkyBoxMaterial
                );

                this.scene.add(aSkybox);
            }

            // Key board
            Outer.prototype.onKeyDown = function (event) {

                switch (event.keyCode) {

                    case 38: // up
                    case 87: // w
                        moveForward = true;
                        // console.log("Move test");
                        break;

                    case 37: // left
                    case 65: // a
                        moveLeft = true;
                        break;

                    case 40: // down
                    case 83: // s
                        moveBackward = true;
                        break;

                    case 39: // right
                    case 68: // d
                        moveRight = true;
                        break;

                    case 32: // space
                        // console.log("Jump test");
                        if (canJump == true)
                            velocity.y += 30;
                        canJump = false;
                        break;

                    case 16:
                        running = true;
                        break;

                }

            };

            Outer.prototype.onKeyUp = function (event) {

                switch (event.keyCode) {

                    case 38: // up
                    case 87: // w
                        moveForward = false;
                        break;

                    case 37: // left
                    case 65: // a
                        moveLeft = false;
                        break;

                    case 40: // down
                    case 83: // s
                        moveBackward = false;
                        break;

                    case 39: // right
                    case 68: // d
                        moveRight = false;
                        break;

                    case 16:
                        running = false;
                        break;

                }
            }

            Outer.prototype.collideDetect = function() {
                // For camera
                var obj_camera = this.viewAABB;
                // With trees
                for (var i = 0; i < this.forest.trees.length; i++) {
                    obj_camera.detect(this.forest.trees[i].AABB);
                }

                for (var i = 0; i < this.cows.cows.length; i++){
                    obj_camera.detect(this.cows.cows[i].AABB);
                }
                for (var i = 0; i < this.wolfs.wolfs.length; i++){
                    obj_camera.detect(this.wolfs.wolfs[i].AABB);
                }
                for (var i = 0; i < this.rabbits.rabbits.length; i++){
                    obj_camera.detect(this.rabbits.rabbits[i].AABB);
                }
                obj_camera.detect(this.barnAABB);
                // if (obj_camera.iscollision) {
                //     console.log("Oops");
                //     obj_camera.collisionOver();
                // }
            }

            return Outer;

        })();

        // var app = new Outer( document.getElementById( 'example' ) );

        var app = new Outer();

        var resizeWindow = function () {
            app.resizeDisplayGL();
        };

        var render = function () {
            requestAnimationFrame(render);
            app.render();

            //console.log(app.forest.trees[0].mesh.position.x);
            if(!app.loading){
                //app.forest.trees[0].mesh.rotation.y += 0.01;
                app.cows.loop();
                app.rabbits.loop();
                app.wolfs.loop();
                app.lake.animate();
            }
                
        };

        function init(event) {
            console.log('Starting initialisation phase...');
            app.initGL();
            app.renderer.setPixelRatio(window.devicePixelRatio);
            app.renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(app.renderer.domElement);

            app.resizeDisplayGL();
            app.initContent();
            render();
        }

        
        window.addEventListener('resize', resizeWindow, false);
        window.addEventListener('load', init, false);


    </script>
</body>

</html>