<!DOCTYPE html>
<html lang="en">
<head>
    <title>Moon and Star Island</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <style>
        body {
            font-family: Monospace;
            background-color: #000;
            color: #fff;
            margin: 0 0 0 0;
            padding: 0 0 0 0;
            border: none;
            cursor: default;
        }
        #info {
            color: #fff;
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            z-index: 100;
            display:block;
        }
        #info a {
            color: #f00;
            font-weight: bold;
            text-decoration: underline;
            cursor: pointer
        }
        #glFullscreen {
            width: 100%;
            height: 100vh;
            min-width: 640px;
            min-height: 360px;
            position: relative;
            overflow: hidden;
            z-index: 0;
        }
        #example {
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background-color: #000000;
        }
        #feedback {
            color: darkorange;
        }
        #dat {
            user-select: none;
            position: absolute;
            left: 0;
            top: 0;
            z-Index: 200;
        }
    </style>
</head>

<body>
<div id="glFullscreen">
    <canvas id="example"></canvas>
</div>
<div id="dat">

</div>

<script src="src/Detector.js"></script>
<script src="src/three.js"></script>
<script src="src/TrackballControls.js"></script>
<script src="src/MTLLoader.js"></script>
<script src="src/OBJLoader.js"></script>
<script src="src/dat.gui.min.js"></script>
<script src="src/LoaderSupport.js"></script>
<script src="src/OBJLoader2.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.0.2/TweenMax.min.js"></script>
<script src="js/myAABB.js"></script>
<script src="js/Forest.js"></script>
<script src="js/Decoration.js"></script>
<script src="js/Cows.js"></script>
<script src="js/Rabbits.js"></script>
<script src="js/Wolfs.js"></script>
<script src="js/Hedgehogs.js"></script>
<script src="js/Water.js"></script>
<script src="js/Lensflare.js"></script>
<!--
<script src="js/Sky.js"></script>
-->
<script>

    'use strict';

    // Other Important Object
    

    var Outer = (function () {

        var Validator = THREE.LoaderSupport.Validator;

        function Outer( elementToBindTo ) {
            this.renderer = null;
            this.canvas = elementToBindTo;
            this.aspectRatio = 1;
            this.recalcAspectRatio();

            this.scene = null;
            this.cameraDefaults = {
                posCamera: new THREE.Vector3( 0.0, 175.0, 500.0 ),
                posCameraTarget: new THREE.Vector3( 0, 0, 0 ),
                near: 0.1,
                far: 10000,
                fov: 45
            };
            this.camera = null;
            this.cameraTarget = this.cameraDefaults.posCameraTarget;

            // Flags
            this.loading = true;

            // Those Assets
            this.controls = null;
            this.objectSet = new THREE.Group();
            // Animals
            this.forest = null;
            this.cows = null;
            this.rabbits = null;
            this.wolfs = null;
            this.hedgehogs = null;
            // Others
            this.ballon = null;
            this.airship = null;
            this.lake = null;
            this.timeDay = 0;
        }

        Outer.prototype.initGL = function () {
            this.renderer = new THREE.WebGLRenderer( {
                canvas: this.canvas,
                antialias: true,
                autoClear: true,
                alpha: true
            } );
            this.renderer.setClearColor( 0x050505 );

            this.scene = new THREE.Scene();

            this.camera = new THREE.PerspectiveCamera( this.cameraDefaults.fov, this.aspectRatio, this.cameraDefaults.near, this.cameraDefaults.far );
            this.resetCamera();
            this.controls = new THREE.TrackballControls( this.camera, this.renderer.domElement );

            //var ambientLight = new THREE.AmbientLight( 0x404040, 0.0 );
            var sunLight = new THREE.PointLight(0x010101, 0.01, 700, 2);
            sunLight.position.set(500, 500, 200);
            var directionalLight1 = new THREE.DirectionalLight( 0x808080 );
            var directionalLight2 = new THREE.DirectionalLight( 0x808080 );
            // 0xC0C090
            directionalLight1.position.set( -100, -50, 100 );
            directionalLight2.position.set( 100, 50, -100 );

            this.scene.add( directionalLight1 );
            this.scene.add( directionalLight2 );

            this.sunZoom();

        };

        // Some misc
        Outer.prototype.ballonUp = function() {
        //function ballonUp() {
            var _this = this;
            TweenMax.to(this.ballon.position, 6, {y: 200, ease:Power1.easeInOut, onComplete:function(){_this.ballonDown()}});
        }

        Outer.prototype.ballonDown = function() {
        //function ballonDown() {
            var _this = this;
            TweenMax.to(this.ballon.position, 6, {y: 0, ease:Power1.easeInOut, onComplete:function(){_this.ballonUp()}});
        }

        Outer.prototype.sunZoom = function() {
            var dirLight = new THREE.DirectionalLight( 0xffffff, 0.05 );
            dirLight.position.set( 5000, 1000, -1000 ).normalize();
            dirLight.color.setHSL( 0.1, 0.7, 0.5 );
            var _ss = this.scene;
            _ss.add( dirLight );
            // lensflares
            var textureLoader = new THREE.TextureLoader();
            var textureFlare0 = textureLoader.load( 'assets/lensflare/lensflare0.png' );
            var textureFlare3 = textureLoader.load( 'assets/lensflare/lensflare3.png' );
            addLight( 0.55, 0.9, 0.5, -5000, 1000, -1000 );
            addLight( 0.08, 0.8, 0.5, -5000, 1000, -1000 );
            addLight( 0.995, 0.5, 0.9, -5000, 1000, -1000 );
            function addLight( h, s, l, x, y, z) {
                var light = new THREE.PointLight( 0xffffff, 1.5, 2000 );
                light.color.setHSL( h, s, l );
                light.position.set( x, y, z );
                _ss.add( light );
                var lensflare = new THREE.Lensflare();
                lensflare.addElement( new THREE.LensflareElement( textureFlare0, 700, 0, light.color ) );
                lensflare.addElement( new THREE.LensflareElement( textureFlare3, 60, 0.6 ) );
                lensflare.addElement( new THREE.LensflareElement( textureFlare3, 70, 0.7 ) );
                lensflare.addElement( new THREE.LensflareElement( textureFlare3, 120, 0.9 ) );
                lensflare.addElement( new THREE.LensflareElement( textureFlare3, 70, 1 ) );
                light.add( lensflare );
            }
        }

        Outer.prototype.initContent = function () {
            var modelName = 'low-poly world';

            var scope = this;
            var objLoader2 = new THREE.OBJLoader2();

            var onLoadMtl = function ( materials, materialCreator ) {
                var objLoader = new THREE.OBJLoader();
                objLoader.setMaterials( materialCreator );
                objLoader.load( './models/moon_star_island_dark.obj', function ( object ) {
                    // Here append anythins

                    // The Trees
                    scope.forest = new Forest();
                    object.add(scope.forest.mesh);
                
                    // The cows
                    scope.cows = new Cows();
                    object.add(scope.cows.mesh);

                    // The rabbits
                    scope.rabbits = new Rabbits();
                    object.add(scope.rabbits.mesh);

                    // The wolfs
                    scope.wolfs = new Wolfs();
                    object.add(scope.wolfs.mesh);

                    // The hedgehogs
                    scope.hedgehogs = new Hedgehogs();
                    object.add(scope.hedgehogs.mesh);

                    // The ballon
                    scope.ballon = object.children[4];

                    // The airship
                    scope.airship = object.children[7];

                    scope.lake = new Lake();
                    object.add(scope.lake.mesh);

                    scope.objectSet.add(object);
                    scope.loading = false;

                    console.log("Cow AABB");
                    console.log(scope.cows.cows[0].AABB.min_x);
                    console.log(scope.cows.cows[0].AABB.max_x);
                    console.log(scope.cows.cows[0].AABB.min_y);
                    console.log(scope.cows.cows[0].AABB.max_y);
                    console.log(scope.cows.cows[0].AABB.min_z);
                    console.log(scope.cows.cows[0].AABB.max_z);

                    console.log("One Tree AABB");
                    console.log(scope.forest.trees[0].AABB.min_x);
                    console.log(scope.forest.trees[0].AABB.max_x);
                    console.log(scope.forest.trees[0].AABB.min_y);
                    console.log(scope.forest.trees[0].AABB.max_y);
                    console.log(scope.forest.trees[0].AABB.min_z);
                    console.log(scope.forest.trees[0].AABB.max_z);

                    scope.cows.cows[0].AABB.detect(
                            scope.forest.trees[0].AABB
                        )

                    scope.cows.cows[0].trigger("forward", 20);

                    scope.rabbits.rabbits[0].trigger("forward", 20);

                    scope.wolfs.wolfs[0].trigger("forward", 20);

                    scope.ballonUp();
                } );
            };
            objLoader2.loadMtl( './models/moon_star_island_dark.mtl', null, onLoadMtl );
            
            this.scene.add(this.objectSet);
            this.loadSkyBox();
            // this.scene.fog = new THREE.FogExp2(0xffffff,0.001);
            // this.sky = new THREE.Sky();
            // this.sky.scale.setScalar( 1000000 );
            // this.scene.add( this.sky );

            // var uniforms = this.sky.material.uniforms;
            // uniforms.turbidity.value = 10;
            // uniforms.rayleigh.value = 2;
            // uniforms.luminance.value = 1;
            // uniforms.mieCoefficient.value = 0.005;
            // uniforms.mieDirectionalG.value = 0.8;
            
        };

        Outer.prototype.resizeDisplayGL = function () {
            this.controls.handleResize();

            this.recalcAspectRatio();
            this.renderer.setSize( this.canvas.offsetWidth, this.canvas.offsetHeight, false );

            this.updateCamera();
        };

        Outer.prototype.recalcAspectRatio = function () {
            this.aspectRatio = ( this.canvas.offsetHeight === 0 ) ? 1 : this.canvas.offsetWidth / this.canvas.offsetHeight;
        };

        Outer.prototype.resetCamera = function () {
            this.camera.position.copy( this.cameraDefaults.posCamera );
            this.cameraTarget.copy( this.cameraDefaults.posCameraTarget );

            this.updateCamera();
        };

        Outer.prototype.updateCamera = function () {
            this.camera.aspect = this.aspectRatio;
            this.camera.lookAt( this.cameraTarget );
            this.camera.updateProjectionMatrix();
        };

        Outer.prototype.render = function () {
            if ( ! this.renderer.autoClear ) this.renderer.clear();
            this.controls.update();
            this.renderer.render( this.scene, this.camera );
        };

        Outer.prototype.loadSkyBox = function() {
            var aCubeMap = THREE.ImageUtils.loadTextureCube([
                'assets/img/px.jpg',
                'assets/img/nx.jpg',
                'assets/img/py.jpg',
                'assets/img/ny.jpg',
                'assets/img/pz.jpg',
                'assets/img/nz.jpg'
            ]);
            aCubeMap.format = THREE.RGBFormat;

            var aShader = THREE.ShaderLib['cube'];
            aShader.uniforms['tCube'].value = aCubeMap;

            var aSkyBoxMaterial = new THREE.ShaderMaterial({
                fragmentShader: aShader.fragmentShader,
                vertexShader: aShader.vertexShader,
                uniforms: aShader.uniforms,
                depthWrite: false,
                side: THREE.BackSide
            });

            var aSkybox = new THREE.Mesh(
              new THREE.BoxGeometry(1000000, 1000000, 1000000),
              aSkyBoxMaterial
            );
        
            this.scene.add(aSkybox);
        }

        return Outer;

    })();

    var app = new Outer( document.getElementById( 'example' ) );

    var resizeWindow = function () {
        app.resizeDisplayGL();
    };

    var render = function () {
        requestAnimationFrame( render );
        app.render();
        app.cows.loop();
        app.rabbits.loop();
        app.wolfs.loop();
        app.lake.animate();
        //console.log(app.forest.trees[0].mesh.position.x);
        // if(!app.loading)
        //    app.forest.trees[0].mesh.rotation.y += 0.01;
        //     if(app.cows.cows[0].AABB.iscollision)
        //         console.log("Oops");
    };

    function init(event){
        console.log( 'Starting initialisation phase...' );
        app.initGL();
        app.resizeDisplayGL();
        app.initContent();
        render();
    }

    window.addEventListener( 'resize', resizeWindow, false );
    window.addEventListener('load', init, false);

</script>
</body>
</html>
